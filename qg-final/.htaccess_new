RewriteEngine On

# Security headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' code.jquery.com cdn.jsdelivr.net cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net cdnjs.cloudflare.com fonts.googleapis.com; font-src 'self' fonts.gstatic.com cdnjs.cloudflare.com; img-src 'self' data:; connect-src 'self'"

# Redirect root domain ke index.php sebagai entry point
RewriteRule ^$ index.php [L]

# Allow specific files and directories
RewriteRule ^(sso_callback|sso_login|sso_logout|index|main|monitoring|profile|api|debug|debug_helper|test_session)\.php$ - [L]
RewriteRule ^(sso_callback_new|sso_login_new)\.php$ - [L]

# Allow assets directory
RewriteRule ^assets/ - [L]

# Allow config directory (but block direct access to PHP files)
RewriteRule ^config/.*\.php$ - [F]
RewriteRule ^config/ - [L]

# Allow includes directory (but block direct access)
RewriteRule ^includes/ - [F]

# Allow docs directory  
RewriteRule ^docs/ - [L]

# Allow logs directory (but block access)
RewriteRule ^logs/ - [F]

# Block access to sensitive files and directories
RewriteRule ^(vendor|composer\.json|composer\.lock|\.git|\.env|\.htaccess) - [F,L]

# Block access to files with sensitive extensions
RewriteRule \.(log|sql|env|ini|bak|old|tmp)$ - [F,L]

# Enable compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Browser caching
<IfModule mod_expires.c>
    ExpiresActive on
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/html "access plus 1 hour"
</IfModule>

# Prevent access to PHP files in specific directories
<Files "*.php">
    <If "%{REQUEST_URI} =~ m#^/includes/.*#">
        Require all denied
    </If>
    <If "%{REQUEST_URI} =~ m#^/config/.*#">
        Require all denied
    </If>
    <If "%{REQUEST_URI} =~ m#^/logs/.*#">
        Require all denied
    </If>
</Files>

# Custom error pages (optional)
# ErrorDocument 403 /error.php?code=403
# ErrorDocument 404 /error.php?code=404
# ErrorDocument 500 /error.php?code=500 